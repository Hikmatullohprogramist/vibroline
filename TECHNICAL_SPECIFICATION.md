# Техническое задание на разработку мобильного приложения VibroLine

## Общее описание

Приложение предназначено для взаимодействия с ESP-устройством, которое работает в двух режимах:
1. **Режим клиента (STA)** – подключено к роутеру
2. **Режим точки доступа (AP)** – создается, если подключение к роутеру не удалось

### Настройки точки доступа:
- **Имя**: VibroLine
- **Пароль**: 12345678

## Архитектура системы

```
┌─────────────────┐    HTTP/WebSocket    ┌─────────────────┐
│   Flutter App   │ ◄─────────────────► │   ESP8266       │
│   (Android)     │                     │   (Arduino)     │
└─────────────────┘                     └─────────────────┘
         │                                       │
         │                                       │
         ▼                                       ▼
┌─────────────────┐                     ┌─────────────────┐
│   Push          │                     │   Sensors       │
│   Notifications │                     │   (Doorbell,    │
└─────────────────┘                     │    Phone, etc.) │
                                       └─────────────────┘
```

## Основной функционал

### 1. Подключение к точке доступа (AP)

**Для Android:**
- Пользователь вручную подключается к Wi-Fi сети VibroLine
- После подключения запускает приложение

**Для iOS:**
- Автоматическое подключение может быть ограничено политиками Apple
- Рекомендуется ручное подключение пользователем

### 2. Определение режима подключения

После запуска приложение выполняет:

**GET-запрос на:** `https://www.kbkontur.ru/iot/get.php`

**Успешный ответ (STA режим):**
```json
{
  "local_ip": "192.168.31.18",
  "mac": "44:17:93:10:F9:A3",
  "global_ip": "78.84.84.235"
}
```

**Если ответ не получен → AP режим:**
- Используется IP: `192.168.4.1`

### 3. Установка WebSocket соединения

**Для STA режима:**
```
ws://<local_ip>/ws
```
Пример: `ws://192.168.31.18/ws`

**Для AP режима:**
```
ws://192.168.4.1/ws
```

### 4. Формат обмена данными по WebSocket

#### При подключении сервер отправляет:
```json
{
  "mac": "44:17:93:10:F9:A3",
  "rssi": 0,
  "gpio": {
    "GPIO1": 1,
    "GPIO2": 1
  }
}
```

**Поля:**
- `mac` – MAC-адрес устройства
- `rssi` – уровень сигнала
- `gpio` – текущее состояние выводов (0 или 1)

#### При изменении GPIO сервер отправляет:
```json
{
  "gpio": {
    "GPIO1": 0
  }
}
```

#### При срабатывании датчика сервер отправляет:
```json
{
  "alarm": {
    "doorbell": 1
  }
}
```

**Типы датчиков:**
- `doorbell` – дверной звонок
- `intercom` – домофон
- `phone` – телефон
- `babycry` – плач ребёнка
- `test` – тестирование системы
- `smoke` – датчик дыма
- `gas` – датчик утечки бытового газа

#### При разряде батарейки сервер отправляет:
```json
{
  "batterylow": {
    "doorbell": 0
  }
}
```

#### Команды от клиента к серверу:

**Настройка Wi-Fi:**
```json
{
  "cmd": "setwifi",
  "ssid": "WiFiName",
  "pass": "пароль"
}
```

**Переключение в AP режим:**
```json
{
  "cmd": "switch_to_ap"
}
```

**Переключение в STA режим:**
```json
{
  "cmd": "switch_to_sta"
}
```

## Техническая реализация

### Структура проекта

```
vibroline/
├── lib/
│   ├── main.dart                 # Точка входа приложения
│   ├── core/
│   │   ├── connection_service.dart      # Определение режима подключения
│   │   ├── auto_connection_service.dart # Автоматическое подключение
│   │   ├── notification_service.dart    # Push уведомления
│   │   └── websocket_service.dart      # WebSocket соединение
│   ├── models/
│   │   └── device_message.dart         # Модель сообщений устройства
│   ├── screens/
│   │   └── auto_home_screen.dart       # Главный экран
│   └── widgets/                        # UI компоненты
├── android/                            # Android специфичные файлы
├── ios/                               # iOS специфичные файлы
└── pubspec.yaml                       # Зависимости
```

### Ключевые компоненты

#### ConnectionService
```dart
class ConnectionService {
  // Определение режима подключения
  Future<String?> determineConnectionMode() async
  
  // Получение информации об устройстве
  Future<Map<String, dynamic>?> getDeviceInfo() async
  
  // Проверка доступности устройства
  Future<bool> testConnection(String ip) async
}
```

#### AutoConnectionService
```dart
class AutoConnectionService {
  // Автоматическое подключение
  Future<void> initialize() async
  
  // Отправка команд устройству
  void sendCommand(Map<String, dynamic> command)
  
  // Настройка Wi-Fi
  void setWiFi(String ssid, String password)
}
```

#### DeviceMessage
```dart
class DeviceMessage {
  final String? mac;
  final int? rssi;
  final Map<String, int>? gpio;
  final Map<String, int>? alarm;
  final Map<String, int>? batteryLow;
}
```

### UI компоненты

#### Главный экран (AutoHomeScreen)
- **Статус подключения** – показывает текущий режим и IP
- **WiFi информация** – имя сети и уровень сигнала
- **История сообщений** – все события от устройства
- **Кнопки управления** – переподключение, настройка WiFi

#### Уведомления
- **Push уведомления** для всех типов тревог
- **Звуковые сигналы** для важных событий
- **Визуальные индикаторы** состояния подключения

## API Endpoints

### ESP8266 Endpoints

#### GET /status
Проверка доступности устройства

**Ответ:**
```json
{
  "status": "ok"
}
```

#### GET /wifi
Получение информации о WiFi

**Ответ:**
```json
{
  "ssid": "WiFiName",
  "rssi": -65,
  "ip": "192.168.1.100",
  "gateway": "192.168.1.1"
}
```

#### WebSocket /ws
Реальное время обмена данными

## Обработка ошибок

### Сетевые ошибки
- **Таймаут подключения** – 5 секунд для HTTP, 3 секунды для WebSocket
- **Автоматическое переподключение** – каждые 5 секунд
- **Fallback на AP режим** – при недоступности API

### Логирование
- **Debug информация** – для разработки
- **Пользовательские сообщения** – понятные ошибки
- **Статус подключения** – визуальная индикация

## Безопасность

### WiFi подключение
- **Пароль AP**: 12345678
- **Шифрование**: WPA2
- **Изоляция клиентов**: включена

### WebSocket
- **Протокол**: ws:// (незащищенный)
- **Аутентификация**: не требуется
- **Валидация данных**: на стороне клиента

## Тестирование

### Unit тесты
```bash
flutter test test/unit/
```

### Widget тесты
```bash
flutter test test/widget/
```

### Интеграционные тесты
```bash
flutter test test/integration/
```

## Развертывание

### Android
```bash
flutter build apk --release
```

### iOS
```bash
flutter build ios --release
```

## Мониторинг

### Метрики
- **Время подключения** – от запуска до установки WebSocket
- **Стабильность соединения** – количество переподключений
- **Задержка сообщений** – время доставки уведомлений

### Логи
- **Уровень**: INFO, WARNING, ERROR
- **Формат**: JSON
- **Ротация**: ежедневно

## Заключение

Данное техническое задание описывает полную архитектуру мобильного приложения VibroLine для взаимодействия с ESP8266 устройством. Приложение обеспечивает надежное подключение в двух режимах работы и обработку всех типов событий от устройства. 